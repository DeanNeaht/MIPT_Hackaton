# Проект: Анализ сайта «СберАвтоподписка» и прогнозирование целевых действий

> **Учебный проект МФТИ Хакатона**  
> Работа выполнена командой 2

## 1. Понимание задачи и цель проекта

### Цель проекта
Разработка модели машинного обучения, которая предсказывает вероятность совершения целевого действия пользователем на сайте «СберАвтоподписка». Целевое действие — это оформление заявки, заказ звонка и другие ключевые активности.

### Практическая значимость
Реализованная модель позволит компании:
- Оценивать эффективность различных каналов привлечения трафика
- Оптимизировать рекламные кампании под наиболее конверсионные сегменты
- Улучшать UX сайта, основываясь на анализе поведения пользователей
- Повысить общую конверсию и эффективность маркетинговых инвестиций

## 2. Анализ исходных данных

В рамках проекта был проведен комплексный анализ логов пользовательских действий на сайте:

- **Исследованы и обработаны пропуски** в ключевых атрибутах пользовательских сессий
- **Проанализированы распределения** важных признаков (utm-метки, устройства, геолокация)
- **Выявлены корреляции** между характеристиками пользователей и вероятностью совершения целевого действия
- **Обнаружены закономерности** в поведении пользователей в зависимости от:
  - Источника трафика (органический vs платный)
  - Устройства (мобильные vs десктоп)
  - Времени посещения
  - Географии

Подробный анализ представлен в файле `final.ipynb` с визуализациями и интерпретациями.

### Структура данных
- **GA Sessions**: 1,860,042 записи с 18 столбцами (информация о визитах)
- **GA Hits**: 15,726,470 записи с 11 столбцами (события в рамках визитов)

## 3. Описание шагов решения задачи

### 3.1. Подготовка и предобработка данных

1. **Загрузка и изучение данных**:
   - Анализ структуры таблиц GA Sessions и GA Hits
   - Изучение типов данных и размерности

2. **Создание целевой переменной**:
   - Определение целевых действий: `'sub_car_claim_click'`, `'sub_car_claim_submit_click'`, `'sub_open_dialog_click'`
   - Создание бинарной переменной `target` (1 - совершено целевое действие, 0 - не совершено)

3. **Обработка пропущенных значений**:
   - Заполнение пропусков в категориальных признаках значением `'(not set)'`
   - Анализ паттернов пропусков в данных

4. **Feature Engineering**:
   - Объединение `visit_date` и `visit_time` в единый datetime признак
   - Извлечение часа из времени визита для анализа временных паттернов
   - Группировка номеров визитов: 1, 2-10, 11+ для снижения размерности
   - Удаление неинформативных столбцов (`session_id`, `client_id`, `device_model`)

5. **Кодирование категориальных признаков**:
   - Применение One-Hot Encoding для всех категориальных переменных
   - Сохранение энкодеров для использования в продакшене

### 3.2. Разделение данных
- Стратифицированное разделение на train/test (80%/20%) с сохранением пропорций классов
- Использование `stratify=y` для корректной работы с несбалансированными данными

### 3.3. Моделирование
1. **Базовая модель**: Логистическая регрессия с параметрами по умолчанию
2. **Оптимизация гиперпараметров**: RandomizedSearchCV для подбора лучших параметров
3. **Продвинутая модель**: CatBoost с 1500 итерациями

## 4. Баланс классов

### Анализ распределения целевой переменной
Данные демонстрируют **сильную разбалансированность классов**:
- **Класс 0** (нет целевого действия): 1,809,728 записей (~97.3%)
- **Класс 1** (есть целевое действие): 50,314 записей (~2.7%)
- **Соотношение классов**: примерно 36:1

### Стратегии работы с дисбалансом
1. **Стратифицированное разделение данных** для сохранения пропорций в train/test
2. **Использование class_weight='balanced'** в логистической регрессии для автоматической корректировки весов классов
3. **Выбор подходящей метрики**: ROC-AUC как основная метрика, устойчивая к дисбалансу классов
4. **Эксперименты с балансировкой**: создание сбалансированной выборки путем undersampling мажоритарного класса

## 5. Обработка выбросов

В рамках данного проекта **специальная обработка выбросов не проводилась** по следующим причинам:

1. **Природа данных**: Веб-аналитические данные (логи пользовательских сессий) по своей природе не содержат классических статистических выбросов
2. **Категориальные признаки**: Большинство признаков являются категориальными (utm-метки, устройства, браузеры), где понятие выброса неприменимо
3. **Временные признаки**: Время визита и номер визита имеют естественные ограничения и не требуют обработки выбросов
4. **Фокус на пропусках**: Основное внимание было уделено корректной обработке пропущенных значений, которые являются более критичными для данного типа задач

## 6. Обоснование выбора модели и метрик

### Выбор моделей

#### Логистическая регрессия
**Преимущества**:
- Интерпретируемость коэффициентов для бизнес-анализа
- Быстрое обучение и предсказание
- Хорошая работа с категориальными признаками после One-Hot Encoding
- Встроенная поддержка балансировки классов (`class_weight='balanced'`)

**Параметры**: `solver='liblinear'`, `class_weight='balanced'`, `tol=1e-6`, `random_state=21`

#### CatBoost
**Преимущества**:
- Отличная работа с категориальными признаками без предварительного кодирования
- Высокое качество предсказаний на табличных данных
- Встроенная регуляризация и защита от переобучения
- Автоматическая обработка пропусков

**Параметры**: 1500 итераций для достижения оптимального качества

#### Результаты моделей
- **Логистическая регрессия**: ROC-AUC ≈ 0.70
- **CatBoost**: ROC-AUC ≈ 0.70 (улучшение на ~7.7%)

### Важность признаков
По результатам анализа коэффициентов логистической регрессии наиболее значимыми оказались:
1. **utm_campaign** (диапазон коэффициентов: -4.05 до 3.99)
2. **device_browser** (-2.82 до 4.16)  
3. **device_brand** (-2.67 до 3.99)
4. **device_os** (-2.06 до 0.76)

## 7. Проектирование решения

Для решения задачи реализован следующий подход:

### Архитектура решения
1. **Подготовка данных**:
   - Обработка категориальных признаков с помощью One-Hot Encoding
   - Работа с временными характеристиками (извлечение часа посещения)
   - Сегментация визитов пользователей (было ли совершено целевое действие)

2. **Модель машинного обучения**:
   - Выбрана и обучена модель на базе LogisticRegression и CatBoost
   - Проведена оптимизация гиперпараметров
   - Достигнута метрика ROC-AUC ≈ 0.70

3. **API-сервис**:
   - Разработан REST API на FastAPI
   - Реализована полная предобработка входящих данных
   - Обеспечено время ответа < 3 секунды

## 8. Реализация прототипа

### Компоненты решения
1. **Аналитический модуль** (`final.ipynb`):
   - Предобработка и анализ данных
   - Разработка и обучение модели
   - Сохранение модели и энкодеров

2. **Проверка продуктовых гипотез** (`Продуктовые гипотезы.ipynb`):
   - Исследование влияния операционной системы на конверсию

3. **API для использования модели** (`app.py`):
   - Реализован полный цикл обработки запросов
   - Корректная предобработка входящих данных
   - Возврат вероятности и класса целевого действия

## 9. Установка и запуск

### Зависимости
```bash
pip install -r requirements.txt
```

### Распаковка модели
Модель CatBoost сжата для экономии места в репозитории. Перед запуском необходимо распаковать её:

**Вариант 1: Автоматическая распаковка (рекомендуется)**
```bash
# Автоматическая распаковка с помощью скрипта
python3 setup_model.py
```

**Вариант 2: Ручная распаковка**
```bash
# Ручная распаковка модели CatBoost
gunzip dc_characters_best.cbm.gz
```

**Примечание**: Файл модели `dc_characters_best.cbm` имеет размер ~199MB и был сжат до ~58MB для соответствия ограничениям GitHub по размеру файлов (100MB).

### Запуск API сервера
```bash
python app.py
```

Сервер будет доступен по адресу http://localhost:8000

### Документация API
После запуска сервера документация доступна по адресам:
- http://localhost:8000/docs - Swagger UI
- http://localhost:8000/redoc - ReDoc

### Тестирование API
```bash
python3 test_api.py
```

## 10. Выводы и рекомендации

В результате проведенного анализа выявлены ключевые факторы, влияющие на конверсию:
  EDA:
    **Время посещения**: вечерние часы демонстрируют повышенную активность пользователей
  Анализ сессий по операционным системам:
    **Источники трафика**: основной вклад в конверсию вносят реферальные источники и переходы по прямым ссылкам.
    **Устройства**: пользователи десктопа с ОС Makintosh показывают более высокую конверсию
    **Посещение страницы**: страницы с детальной информацией (FAQ, каталог) играют решающую роль в принятии решения.
  Анализ пользователей и сессий по городам:
    **Источники трафика**: основной вклад в конверсию вносят реферальные источники и переходы по прямым ссылкам.
    **Устройства**: чаще заходят на сайт с мобильных устройств
    **Частота посещения**: москвичи чаще возращаются на сайт, чем пользователи из других городов.
    
Рекомендации для бизнеса:
- Инвестируйте в партнерские программы и улучшение UX.
- Перераспределить рекламный бюджет в пользу наиболее эффективных каналов
- Оптимизировать мобильную версию сайта для повышения конверсии
